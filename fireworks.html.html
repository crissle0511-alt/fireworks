<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fireworks</title>
  <style>
    html, body { margin: 0; height: 100%; background: #000; overflow: hidden; }
    canvas { display:block; }
  </style>
</head>
<body>
<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

/* ====== MUSIC (ADDED ONLY) ====== */
const bgMusic = new Audio("music.mp3"); // file nhạc đặt cùng folder với fireworks.html
bgMusic.loop = true;
bgMusic.volume = 0.45; // chỉnh âm lượng: 0.0 -> 1.0
let musicStarted = false;
/* =============================== */

function resize() {
  canvas.width  = innerWidth * devicePixelRatio;
  canvas.height = innerHeight * devicePixelRatio;
  canvas.style.width  = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
}
addEventListener("resize", resize);
resize();

const gravity = 0.06;
const rockets = [];
const sparks  = [];
function rand(a,b){ return a + Math.random()*(b-a); }

// ====== SEQUENCE (repeat forever) ======
let totalClicks = 0;
const CYCLE = 20;
const HEART_AT = 5;   // click 5
const DOG_AT   = 15;  // click 15
const NY_AT    = 20;  // click 20

// Only ONE scene at a time
let scene = "none"; // "none" | "heart" | "dog" | "ny"

// ====== click only ======
addEventListener("mousedown", (e) => onClickShoot(e.clientX));
addEventListener("touchstart", (e) => onClickShoot(e.touches[0].clientX), { passive:true });

function onClickShoot(x){

  /* ====== MUSIC START ON FIRST CLICK (ADDED ONLY) ====== */
  if (!musicStarted) {
    bgMusic.play().catch(() => {}); // tránh lỗi console nếu browser chặn tạm
    musicStarted = true;
  }
  /* ==================================================== */

  totalClicks++;
  const inCycle = ((totalClicks - 1) % CYCLE) + 1; // 1..20

  // scene rules: NO OVERLAP
  if (inCycle >= 1 && inCycle <= 4) scene = "none";
  if (inCycle === HEART_AT) scene = "heart";
  if (inCycle === DOG_AT)   scene = "dog";
  if (inCycle === NY_AT)    scene = "ny";

  // launch rocket; special spark only at heart click
  launch(x, innerHeight, (inCycle === HEART_AT) ? "heart" : "normal");
}

// ====== fireworks ======
function launch(x, y, specialType){
  rockets.push({
    x, y,
    vx: rand(-1.2, 1.2),
    vy: rand(-9.5, -12.5),
    life: rand(40, 70),
    hue: rand(0, 360),
    specialType
  });
}

function explodeNormal(x, y, hue){
  const count = 100;
  for (let i=0;i<count;i++){
    const a = rand(0, Math.PI*2);
    const speed = rand(1.5, 5);
    sparks.push({
      x, y,
      vx: Math.cos(a)*speed,
      vy: Math.sin(a)*speed,
      drag: 0.98,
      life: 80,
      size: rand(1, 2.5),
      hue,
      alpha: 1
    });
  }
}

function explodeHeartSparks(x, y){
  const points = 140;
  for (let i=0;i<points;i++){
    const t = (Math.PI*2*i)/points;
    const hx = 16*Math.pow(Math.sin(t),3);
    const hy = -(13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
    sparks.push({
      x, y,
      vx: hx*0.18,
      vy: hy*0.18,
      drag: 0.99,
      life: 95,
      size: rand(1.2, 2.8),
      hue: 330,
      alpha: 1
    });
  }
}

// ====== draw vector shapes ======
function drawHeartShape(x, y, s){
  ctx.beginPath();
  for (let i = 0; i <= 220; i++) {
    const t = (Math.PI * 2 * i) / 220;
    const hx = 16 * Math.pow(Math.sin(t), 3);
    const hy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
    const px = x + hx * s;
    const py = y + hy * s;
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.closePath();
  ctx.fill();
}

function drawCorgi(x, y, k){
  ctx.save();
  ctx.translate(x, y);
  ctx.scale(k, k);

  ctx.globalAlpha = 0.25;
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.ellipse(0, 70, 70, 16, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;

  ctx.fillStyle = "rgb(230,150,70)";
  ctx.beginPath(); ctx.roundRect(-85, 10, 170, 80, 40); ctx.fill();

  ctx.fillStyle = "rgb(245,235,225)";
  ctx.beginPath(); ctx.roundRect(-40, 30, 80, 55, 30); ctx.fill();

  ctx.fillStyle = "rgb(230,150,70)";
  for (const lx of [-60, -20, 20, 60]){
    ctx.beginPath(); ctx.roundRect(lx-14, 70, 28, 28, 10); ctx.fill();
  }

  ctx.fillStyle = "rgb(230,150,70)";
  ctx.beginPath(); ctx.roundRect(-70, -55, 140, 95, 45); ctx.fill();

  ctx.fillStyle = "rgb(245,235,225)";
  ctx.beginPath(); ctx.roundRect(-45, -25, 90, 55, 30); ctx.fill();

  ctx.fillStyle = "rgb(230,150,70)";
  ctx.beginPath(); ctx.roundRect(-78, -78, 36, 40, 14); ctx.fill();
  ctx.beginPath(); ctx.roundRect( 42, -78, 36, 40, 14); ctx.fill();

  ctx.fillStyle = "rgb(255,190,185)";
  ctx.beginPath(); ctx.roundRect(-70, -70, 22, 26, 10); ctx.fill();
  ctx.beginPath(); ctx.roundRect( 48, -70, 22, 26, 10); ctx.fill();

  ctx.fillStyle = "#111";
  ctx.beginPath(); ctx.arc(-22, -10, 6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( 22, -10, 6, 0, Math.PI*2); ctx.fill();

  ctx.beginPath(); ctx.arc(0, 8, 7, 0, Math.PI*2); ctx.fill();

  ctx.strokeStyle = "#111";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(0, 12);
  ctx.quadraticCurveTo(-12, 22, -22, 18);
  ctx.moveTo(0, 12);
  ctx.quadraticCurveTo( 12, 22,  22, 18);
  ctx.stroke();

  ctx.fillStyle = "rgb(230,150,70)";
  ctx.beginPath(); ctx.roundRect(82, 30, 22, 36, 12); ctx.fill();

  ctx.restore();
}

function drawMatcha(x, y, k){
  ctx.save();
  ctx.translate(x, y);
  ctx.scale(k, k);

  ctx.globalAlpha = 0.25;
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.ellipse(0, 110, 70, 14, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;

  ctx.strokeStyle = "rgba(255,255,255,0.65)";
  ctx.lineWidth = 3;
  ctx.fillStyle = "rgba(255,255,255,0.08)";
  ctx.beginPath(); ctx.roundRect(-70, -20, 140, 135, 28); ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(120, 200, 120, 0.55)";
  ctx.beginPath(); ctx.roundRect(-62, 20, 124, 84, 22); ctx.fill();

  ctx.fillStyle = "rgba(255,255,255,0.22)";
  for (let i=0;i<6;i++){
    const ix = rand(-45, 45);
    const iy = rand(18, 70);
    ctx.beginPath(); ctx.roundRect(ix, iy, 18, 14, 4); ctx.fill();
  }

  ctx.fillStyle = "rgba(255,255,255,0.14)";
  ctx.strokeStyle = "rgba(255,255,255,0.55)";
  ctx.beginPath(); ctx.roundRect(-78, -45, 156, 30, 18); ctx.fill(); ctx.stroke();

  ctx.strokeStyle = "rgba(120, 220, 120, 0.95)";
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.moveTo(20, -70);
  ctx.lineTo(25, -40);
  ctx.lineTo(25, 30);
  ctx.stroke();

  ctx.restore();
}

// ====== draw scene (ONLY ONE) ======
function drawScene(){
  if (scene === "heart"){
    const cx = innerWidth/2;
    const cy = innerHeight*0.28;

    ctx.fillStyle = "rgba(255,105,180,0.95)";
    drawHeartShape(cx, cy, 8.5);

    ctx.fillStyle = "rgba(255,105,180,0.95)";
    ctx.font = "30px sans-serif";
    ctx.textAlign = "center";

    ctx.fillText("én nì thối", cx, cy + 205);
  }

  if (scene === "dog"){
    drawCorgi(170, innerHeight - 170, 1.0);
    drawMatcha(innerWidth - 170, innerHeight - 190, 1.0);
  }

  if (scene === "ny"){
    ctx.fillStyle = "rgba(255, 220, 120, 0.98)";
    ctx.font = "bold 44px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("Happy New Year Bae", innerWidth/2, innerHeight*0.16);
  }
}

// ====== loop ======
function tick(){
  requestAnimationFrame(tick);

  ctx.fillStyle = "rgba(0,0,0,0.2)";
  ctx.fillRect(0, 0, innerWidth, innerHeight);

  drawScene();

  for (let i=rockets.length-1;i>=0;i--){
    const r = rockets[i];
    r.x += r.vx;
    r.y += r.vy;
    r.vy += gravity*0.35;
    r.life--;

    ctx.fillStyle = `hsl(${r.hue},100%,70%)`;
    ctx.beginPath();
    ctx.arc(r.x, r.y, 2.2, 0, Math.PI*2);
    ctx.fill();

    if (r.life <= 0 || r.vy > -2){
      if (r.specialType === "heart") explodeHeartSparks(r.x, r.y);
      else explodeNormal(r.x, r.y, r.hue);
      rockets.splice(i, 1);
    }
  }

  for (let i=sparks.length-1;i>=0;i--){
    const s = sparks[i];
    s.x += s.vx;
    s.y += s.vy;
    s.vy += gravity;
    s.vx *= s.drag;
    s.life--;
    s.alpha = s.life / 95;

    ctx.fillStyle = `hsla(${s.hue},100%,65%,${s.alpha})`;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
    ctx.fill();

    if (s.life <= 0) sparks.splice(i, 1);
  }
}
tick();
</script>
</body>
</html>
